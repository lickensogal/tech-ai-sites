<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subscribers | TechAI Admin</title>
  <link rel="stylesheet" href="../assets/css/admin.css" />
</head>
<body>
  <div class="admin-container">
    <aside class="admin-sidebar">
      <h2>TechAI Admin</h2>
      <nav>
        <ul>
          <li><a href="index.html">Dashboard</a></li>
          <li><a href="posts.html">Posts</a></li>
          <li><a href="categories.html">Categories</a></li>
          <li><a href="ads.html">Ads</a></li>
          <li><a href="analytics.html">Analytics</a></li>
          <li><a href="subscribers.html" class="active">Subscribers</a></li>
        </ul>
      </nav>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>Subscribers Management</h1>
      </header>

      <section class="subscribers-section">
        <div class="subscribers-header">
          <input type="text" id="searchInput" placeholder="Search subscriber..." />
          <button id="exportCSV">Export CSV</button>
        </div>

        <table class="subscribers-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>Date Subscribed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="subscribersList">
            <!-- Dynamically Loaded -->
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
  <script src="../firebase/config.js"></script>
  <script src="../firebase/firestore.js"></script>

  <script>
    const db = firebase.firestore();
    const subscribersList = document.getElementById('subscribersList');
    const searchInput = document.getElementById('searchInput');

    // Fetch subscribers from Firestore
    async function loadSubscribers() {
      const snapshot = await db.collection('subscribers').orderBy('date', 'desc').get();
      subscribersList.innerHTML = '';
      let count = 1;
      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${count++}</td>
          <td>${data.email}</td>
          <td>${data.date.toDate().toLocaleDateString()}</td>
          <td><button class="delete-btn" data-id="${doc.id}">Delete</button></td>
        `;
        subscribersList.appendChild(tr);
      });
      attachDeleteEvents();
    }

    // Delete subscriber
    function attachDeleteEvents() {
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if(confirm('Are you sure you want to delete this subscriber?')) {
            await db.collection('subscribers').doc(id).delete();
            loadSubscribers();
          }
        });
      });
    }

    // Search functionality
    searchInput.addEventListener('input', () => {
      const filter = searchInput.value.toLowerCase();
      document.querySelectorAll('#subscribersList tr').forEach(tr => {
        const email = tr.children[1].textContent.toLowerCase();
        tr.style.display = email.includes(filter) ? '' : 'none';
      });
    });

    // Export CSV
    document.getElementById('exportCSV').addEventListener('click', () => {
      const rows = [['#', 'Email', 'Date Subscribed']];
      document.querySelectorAll('#subscribersList tr').forEach((tr, index) => {
        const cells = tr.querySelectorAll('td');
        rows.push([index + 1, cells[1].textContent, cells[2].textContent]);
      });
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "subscribers.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Initial load
    loadSubscribers();
  </script>
  <script src="js/admin.js"></script>
</body>
</html>

